<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AntiTruffa — Verifica</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f5f7fb; margin:0; color:#0f172a; }
    header, footer { background:#fff; border-bottom:1px solid #e2e8f0; }
    footer { border-top:1px solid #e2e8f0; border-bottom:none; }
    .wrap { max-width: 980px; margin:0 auto; padding:18px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:18px; padding:18px; box-shadow: 0 1px 2px rgba(15,23,42,.06); }
    .tabs { display:flex; gap:8px; margin-top:14px;}
    .tab { border:1px solid #e2e8f0; background:#fff; padding:10px 14px; border-radius:14px; cursor:pointer; font-weight:600; font-size:14px;}
    .tab.active { background:#0f172a; color:#fff; border-color:#0f172a; }
    textarea { width:100%; min-height:160px; border:1px solid #e2e8f0; border-radius:14px; padding:12px; font-size:14px; }
    input[type=file], select { border:1px solid #e2e8f0; border-radius:14px; padding:10px 12px; background:#fff; }
    .btn { background:#2563eb; color:#fff; border:none; padding:12px 16px; border-radius:16px; font-weight:700; cursor:pointer; }
    .btn:disabled { background:#cbd5e1; cursor:not-allowed; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px; }
    @media (max-width: 820px){ .grid { grid-template-columns: 1fr; } }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; border:1px solid; }
    .basso { background:#dcfce7; border-color:#86efac; color:#166534; }
    .medio { background:#fef9c3; border-color:#fde047; color:#854d0e; }
    .alto { background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    .muted { color:#64748b; font-size:12px; }
    .bar { height:8px; background:#e2e8f0; border-radius:999px; overflow:hidden; }
    .bar > div { height:100%; }
    .bar .g { background:#22c55e; }
    .bar .y { background:#eab308; }
    .bar .r { background:#ef4444; }
    .list { padding-left: 18px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .small { font-size:13px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .link { color:#2563eb; text-decoration:none; font-weight:600; }
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div style="font-weight:800;">AntiTruffa</div>
    <div class="row">
      <a class="link" href="/">Verifica</a>
      <a class="link" href="/stats">Statistiche</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <h2 style="margin:0 0 6px 0;">Hai ricevuto un messaggio sospetto?</h2>
    <div class="muted">Incolla il testo o carica uno screenshot. Ottieni un rischio stimato e cosa fare. (Non inserire OTP/password/carta.)</div>

    <div class="tabs" id="tabs">
      <button class="tab active" id="tabText" type="button">Testo</button>
      <button class="tab" id="tabImg" type="button">Screenshot</button>
    </div>

    <div id="paneText" style="margin-top:12px;">
      <div class="row" style="margin-bottom:10px;">
        <label class="muted">Fonte</label>
        <select id="source">
          <option value="sms">SMS</option>
          <option value="email">Email</option>
          <option value="whatsapp">WhatsApp</option>
          <option value="other">Altro</option>
        </select>
      </div>
      <textarea id="text" placeholder="Incolla qui il messaggio…"></textarea>
      <div class="muted" id="count">0/5000</div>
      <div style="margin-top:10px;">
        <button class="btn" id="btnText">Verifica</button>
      </div>
    </div>

    <div id="paneImg" style="margin-top:12px; display:none;">
      <input type="file" id="file" accept="image/*"/>
      <div class="muted" style="margin-top:8px;">Carica uno screenshot (SMS/email). Evita documenti e dati sensibili.</div>
      <div style="margin-top:10px;">
        <button class="btn" id="btnImg">Verifica</button>
      </div>
    </div>
  </div>

  <div id="result" class="grid" style="display:none;">
    <div class="card">
      <div class="top">
        <div id="badge" class="badge basso">Rischio BASSO</div>
        <div style="font-weight:800;" id="score">0/100</div>
      </div>
      <div style="margin-top:10px;" class="bar"><div id="barFill" class="g" style="width:0%"></div></div>

      <h3 style="margin:14px 0 8px 0;">Segnali principali</h3>
      <div id="signals" class="small muted">—</div>

      <div style="margin-top:12px;" class="row">
        <label class="muted"><input type="checkbox" id="consent" checked/> Salva solo indicatori anonimi per statistiche</label>
        <button class="btn" id="btnReport" type="button">Segnala (anonimo)</button>
        <span class="muted" id="reportMsg"></span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px 0;">Cosa fare adesso</h3>
      <ul id="advice" class="list small"></ul>
      <div class="muted" id="extras" style="margin-top:10px;"></div>
      <div style="margin-top:12px; padding:10px 12px; border-radius:14px; border:1px solid #e2e8f0; background:#f8fafc;" class="small">
        Non inserire mai OTP/password/carta. Se c'è un pagamento, usa SOLO canali ufficiali.
      </div>
    </div>
  </div>
</main>

<footer>
  <div class="wrap muted">⚠️ Valutazione probabilistica, non prova. Non inserire dati sensibili.</div>
</footer>

<script>
const tabText = document.getElementById("tabText");
const tabImg  = document.getElementById("tabImg");
const paneText = document.getElementById("paneText");
const paneImg  = document.getElementById("paneImg");

tabText.onclick = () => { tabText.classList.add("active"); tabImg.classList.remove("active"); paneText.style.display="block"; paneImg.style.display="none"; }
tabImg.onclick  = () => { tabImg.classList.add("active"); tabText.classList.remove("active"); paneImg.style.display="block"; paneText.style.display="none"; }

const text = document.getElementById("text");
const count = document.getElementById("count");
text.addEventListener("input", () => { count.textContent = `${text.value.length}/5000`; });

function levelClass(level){
  if(level==="alto") return ["alto","r"];
  if(level==="medio") return ["medio","y"];
  return ["basso","g"];
}

let lastPayload = null;

async function showResult(res, kind){
  document.getElementById("result").style.display="grid";
  const badge = document.getElementById("badge");
  const score = document.getElementById("score");
  const bar = document.getElementById("barFill");
  const signals = document.getElementById("signals");
  const advice = document.getElementById("advice");
  const extras = document.getElementById("extras");
  const reportMsg = document.getElementById("reportMsg");
  reportMsg.textContent = "";

  const [cls, barCls] = levelClass(res.risk_level);
  badge.className = `badge ${cls}`;
  badge.textContent = `Rischio ${res.risk_level.toUpperCase()}`;
  score.textContent = `${res.risk_score}/100`;
  bar.className = barCls;
  bar.style.width = Math.max(0, Math.min(100, res.risk_score)) + "%";

  const top = (res.signals || []).slice().sort((a,b)=>(b.weight||0)-(a.weight||0)).slice(0,3);
  signals.innerHTML = top.length ? top.map(s => `<div><b>${s.code}</b> <span class="muted">+${s.weight}</span></div>`).join("") : "<span class='muted'>Nessun segnale forte rilevato.</span>";

  advice.innerHTML = "";
  const items = kind==="text" ? (res.advice || []) : (res.notes || []);
  items.forEach(a => {
    const li = document.createElement("li");
    li.textContent = a;
    advice.appendChild(li);
  });

  if(kind==="text"){
    extras.innerHTML = `<div><b>Categoria stimata:</b> ${res.category}</div>`
      + (res.domains && res.domains.length ? `<div><b>Domini:</b> ${res.domains.join(", ")}</div>` : "")
      + (res.phones && res.phones.length ? `<div><b>Numeri:</b> ${res.phones.join(", ")}</div>` : "");
  } else {
    extras.innerHTML = `<div><b>EXIF presente:</b> ${res.exif_present ? "sì" : "no"}</div><div><b>Categoria:</b> ${res.category}</div>`;
  }

  lastPayload = { kind, res };
}

async function analyzeText(){
  const src = document.getElementById("source").value;
  const t = document.getElementById("text").value;
  const r = await fetch("/api/analyze/text", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({text:t, source:src})});
  if(!r.ok) throw new Error(await r.text());
  const res = await r.json();
  await showResult(res, "text");
}

async function analyzeImage(){
  const f = document.getElementById("file").files[0];
  if(!f) throw new Error("Carica un'immagine.");
  const fd = new FormData();
  fd.append("file", f);
  const r = await fetch("/api/analyze/image", { method:"POST", body: fd });
  if(!r.ok) throw new Error(await r.text());
  const res = await r.json();
  await showResult(res, "image");
}

document.getElementById("btnText").onclick = async () => {
  try { await analyzeText(); } catch(e){ alert(e.message || e); }
};
document.getElementById("btnImg").onclick = async () => {
  try { await analyzeImage(); } catch(e){ alert(e.message || e); }
};

document.getElementById("btnReport").onclick = async () => {
  try{
    if(!lastPayload) return;
    const consent = document.getElementById("consent").checked;
    if(!consent) { alert("Attiva la spunta del consenso (salviamo solo indicatori anonimi)."); return; }
    const kind = lastPayload.kind;
    const res = lastPayload.res;
    const payload = kind==="text" ? {
      type:"text",
      source: document.getElementById("source").value,
      category: res.category,
      risk_score: res.risk_score,
      risk_level: res.risk_level,
      fingerprint: res.fingerprint,
      signals: res.signals || [],
      domains: res.domains || [],
      phones: res.phones || []
    } : {
      type:"image",
      source:"image",
      category: res.category,
      risk_score: res.risk_score,
      risk_level: res.risk_level,
      fingerprint: res.fingerprint,
      signals: res.signals || [],
      domains: [],
      phones: []
    };

    const r = await fetch("/api/report", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    if(!r.ok) throw new Error(await r.text());
    const out = await r.json();
    document.getElementById("reportMsg").textContent = out.dedup ? "Già segnalato recentemente (dedup)." : "Segnalazione salvata.";
  } catch(e){ alert(e.message || e); }
};
</script>
</body>
</html>
